<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>PyWebview Demo</title>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>
    <div class="top-bar">
      PRB to Excel
      <button class="round-button" onclick="pywebview.api.openGithubWiki()">
        ?
      </button>
    </div>
    <div class="center"> <!-- Contains the svg's, buttons, and output boxes, so the main section -->

      <div class="column" id="dir-col-line" > <!-- Each column is a vertical section in the resulting UI -->
        <div class="temp-art" id="c1-art" style="--icon: url('./OpenDirectoryIcon.svg');"></div>
        <button class="action-button" onclick="openGroupDialog()" id="c1-button-1">Choose Individual PRB Group Folder</button>
        <button class="action-button" onclick="openRootDialog(true)" id="c1-button-2">Choose PRB Folder Containing Group Folders</button>
        <p class="display-title" id="text-input-title"></p>
        <div class="display-text-area" id="text-input-rows"></div>
      </div>

      <div class="column" id="run-col-line">
        <div class="temp-art" id="c2-art" style="--icon: url('./TargetDirectoryIcon.svg');"></div>
        <button class="action-button" onclick="openRootDialog()" id="c2-button-1">Target Directory</button>
        <button class="action-button fake">Not Clickable</button>
        <p class="display-title" id="text-destination-title"></p>
        <div class="display-text-area" id="text-destination-rows"></div>
      </div>

      <div class="column">
        <div class="temp-art" id="c3-art" style="--icon: url('./XLSXFileIcon.svg');"></div>
        <button class="action-button" onclick="generateExcel()" id="c3-button-1">Generate Excel</button>
        <button class="action-button fake">Not Clickable</button>
      </div>

    </div>

    <script>
    //Here, we have arrays of each columns elements we need to interact with for
    //animation purposes. This lets us just loop through them when we need to
    //set column-wide changes (color, display, appearance...)
    const c1 = [
      document.getElementById("c1-art"),
      document.getElementById("c1-button-1"),
      document.getElementById("c1-button-2"),
      document.getElementById("text-input-title"),
      document.getElementById("text-input-rows")
    ];
    const c2 = [
      document.getElementById("c2-art"),
      document.getElementById("c2-button-1"),
      document.getElementById("text-destination-title"),
      document.getElementById("text-destination-rows"),
      document.getElementById("dir-col-line")
    ];
    const c3 = [
      document.getElementById("c3-art"),
      document.getElementById("c3-button-1"),
      document.getElementById("run-col-line")
    ];

    //boolean for use in generateExcel where we'll decide if root or group folder generation
    let rootFolder = false;

    //activate the first column to allow usage (everything's grey/disabled to
    //start, then we call this function to make colored and interactable)
    applyColoredClass(c1);

    async function openGroupDialog() {
      // call Python method exposed as js_api
      const result = await pywebview.api.open_group_dialog();
      await pywebview.api.print(result);
      if (result[0]) {
        document.getElementById("text-input-title").innerHTML = "Choosen PRB Files:";
        clearText("text-input-rows");
        for (let res of result) {
          addRowText("text-input-rows", res);
        }

        //after first column success, color next section to show order to user
        //applyColoredClass(c2);
        applyColoredClass(c3);
      } else {
        await pywebview.api.print("No files choosen");
      }
    }

    async function openRootDialog(get_files_from_dir=false) {
      const dir_path = await pywebview.api.open_root_dialog(get_files_from_dir);
      if (dir_path && !get_files_from_dir) {
        document.getElementById("text-destination-title").innerHTML = "Destination Directory:";
        clearText("text-destination-rows");
        addRowText("text-destination-rows", dir_path);

        //after second column success, color next section to show order to user
        applyColoredClass(c3);
      } else if (dir_path[0] && get_files_from_dir) {
        document.getElementById("text-input-title").innerHTML = "Choosen PRB Files:";
        clearText("text-input-rows");
        for (let res of dir_path) {
          addRowText("text-input-rows", res);
        }

        //after first column success, color next section to show order to user
        //applyColoredClass(c2);
        applyColoredClass(c3);
        rootFolder = true;
      } else {
        await pywebview.api.print(typeof dir_path);
      }
    }

    async function generateExcel() {
      const result = await pywebview.api.generate_excel_file(rootFolder);
      await pywebview.api.print(typeof result);
      if (result) {
        await pywebview.api.print("true");
      } else {
        await pywebview.api.print("false");
      }
    }

    function addRowWithText(table_id, text) {
      const table_body = document.getElementById(table_id).getElementsByTagName("tbody")[0];
      const newRow = tableBody.insertRow(-1);
      const cell = newRow.insertCell(-1);
      cell.innerHTML = text;
    }

    //adds <p>'text'</p> to the innerhtml of a passed element id
    function addRowText(sec_id, text) {
      const sec = document.getElementById(sec_id);
      const last_slash_index = text.lastIndexOf("/")
      let text_anchor = "";
      if (last_slash_index !== -1) {
        text_anchor = text.slice(last_slash_index+1);
      } else {text_anchor = text;}
      sec.innerHTML += `<p title="${text}">${text_anchor}<br></p>`;
    }

    function clearText(sec_id) {
      const sec = document.getElementById(sec_id);
      sec.innerHTML = "";
    }

    //iterate through array, apply colored class to each html element
    function applyColoredClass(col_arr) {
      for (let e of col_arr) {
        if (!e) {continue;}

        e.style.pointerEvents = "auto";
        switch (e.tagName) {
          case "BUTTON":
            e.style.backgroundColor = "var(--button-color)";
            e.style.cursor = "pointer";
            e.style.setProperty("--no-interact-bg", "rgba(45, 35, 66, 0.4)");
            e.style.setProperty("--no-interact-shadow", "#f8b878");
            break;
          case "DIV": //TODO: svg fill change, leave div as the text input
            if (!classListContains(e, ["display-title", "temp-art", "column"])) { //replace this if with just the div change later
              e.style.boxShadow = "var(--button-shadow-light) 0 3px 7px inset";
            } else if (e.classList.contains("column")) {
              e.style.setProperty("--line-color", "#222222");
            } else { //TODO: replace this with a switch for an svg later
              e.style.backgroundColor = "#000000";
            }
            break;
          case "P":
            e.style.backgroundColor = "var(--button-color)";
            break;
        }
      }
    }

    function classListContains(e, class_list) {
      for (const c of class_list) {
        if (e.classList.contains(c)) {return true;}
      }
      return false;
    }

    //this is for object with keys as digits from pywebview dialog return
    function makeObjIntoArray(obj) {
      let arr = [];
      Object.keys(file_obj).forEach((key) => { message.push(file_obj[key]) });
      return arr;
    }

    function openGithubWiki() {
      pywebview.api.openGithubWiki();
    }
    </script>
  </body>
</html>
